<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sale Invoice â€” {{ doc.id }}</title>
  <style>
    html, body { margin: 0; padding: 0; font-family: Arial, Helvetica, sans-serif; font-size: 12px; color: #111; }
    .page { width: 210mm; min-height: 297mm; padding: 16mm 15mm; box-sizing: border-box; }
    h1, h2, h3 { margin: 0; padding: 0; }
    .header { display: grid; grid-template-columns: 65% 35%; gap: 16px; align-items: start; }
    .company-block { display: block; }
    .company-name { font-size: 22px; font-weight: 700; line-height: 1.1; }
    .company-lines { margin-top: 6px; line-height: 1.35; white-space: pre-wrap; text-align: left; }
    .meta { text-align: right; }
    .doc-title { font-size: 18px; font-weight: 700; letter-spacing: 0.5px; }
    .meta small { color: #555; }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 10px; font-size: 10px; font-weight: 700; }
    .badge.paid { background: #e7f6ec; color: #137333; }
    .badge.partial { background: #fff7e6; color: #b36b00; }
    .badge.unpaid { background: #fdeaea; color: #b3261e; }

    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px; }
    .card { border: 1px solid #ddd; border-radius: 6px; padding: 10px; }
    .card h3 { font-size: 12px; font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .4px; }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 6px 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    th { text-align: left; background: #fafafa; font-weight: 700; }
    .items-table { table-layout: fixed; }
    .items-table .col-idx { width: 24px; }
    .items-table .col-qty,
    .items-table .col-uom { width: 60px; }
    .items-table .col-unit-price,
    .items-table .col-discount,
    .items-table .col-line-total { width: 80px; }
    .t-right { text-align: right; }
    .totals { width: 50%; margin-left: auto; margin-top: 6px; }
    .totals table { margin-top: 0; }
    .totals .rule { border-top: 1px solid #ccc; }
    .muted { color: #666; }
    .footer { margin-top: 18px; font-size: 11px; color: #444; display: grid; grid-template-columns: 1fr; gap: 6px; }

    .payment-details { margin-top: 16px; }
    .payment-card {
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 10px;
        background: #fafafa;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .payment-card h3 {
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: .4px;
    }
    .payment-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
  </style>
</head>
<body>
  <div class="page">
    <!-- Header -->
    <div class="header">
      <div class="company-block">
        <div class="company-name">{{ company.name }}</div>
        <div class="company-lines">
Address: XXXX<br>
XXXXX: XXXXXX<br>
XXXXXX: XXXXXX
        </div>
      </div>
      <div class="meta">
        <div class="doc-title">SALE INVOICE</div>
        <div><small>Document No:</small> <strong>{{ doc.id }}</strong></div>
        <div><small>Date:</small> <strong>{{ doc.date }}</strong></div>
        {% if doc.payment_status %}
          {% set ps = (doc.payment_status|string).lower() %}
          <div style="margin-top:6px;">
            <span class="badge {{ 'paid' if ps=='paid' else ('partial' if ps=='partial' else 'unpaid') }}">
              {{ doc.payment_status|upper }}
            </span>
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Parties & Bank -->
    <div class="two-col">
      <div class="card">
        <h3>Bill To</h3>
        <div><strong>{{ customer.name }}</strong></div>
        <div class="muted">{{ customer.contact_info }}</div>
        {% if customer.address %}
          <div style="white-space: pre-wrap; margin-top: 4px;">{{ customer.address }}</div>
        {% endif %}
      </div>
      <div class="card">
        <h3>Bank Details</h3>
        <!-- Fixed bank blocks as requested -->
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
          <div>
            <div><strong>XXXXX Bank</strong></div>
            <div>Account Title: XXXX</div>
            <div>Account No: XXXX</div>
          </div>
          <div>
            <div><strong>XXXX XXXX Bank</strong></div>
            <div>Account Title: XXXXX</div>
            <div>Account No: XXXX</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Items -->
    {% set has_line_discount = (items|sum(attribute='item_discount')) > 0 %}
    <table class="items-table" aria-label="Line items">
      <thead>
        <tr>
          <th class="col-idx t-right">#</th>
          <th>Product</th>
          <th class="col-qty t-right">Qty</th>
          <th class="col-uom">UoM</th>
          <th class="col-unit-price t-right">Unit Price</th>
          {% if has_line_discount %}
          <th class="col-discount t-right">Discount</th>
          {% endif %}
          <th class="col-line-total t-right">Line Total</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td class="t-right">{{ it.idx }}</td>
          <td>{{ it.product_name }}</td>
          <td class="t-right">{{ '%.2f' % it.quantity }}</td>
          <td>{{ it.uom_name }}</td>
          <td class="t-right">{{ '%.2f' % it.unit_price }}</td>
          {% if has_line_discount %}
          <td class="t-right">
            {% if it.item_discount and it.item_discount > 0 %}
              {{ '%.2f' % it.item_discount }}<br>
              <span class="muted">x {{ '%.2f' % it.quantity }}</span>
            {% else %}
              {{ '%.2f' % it.item_discount }}
            {% endif %}
          </td>
          {% endif %}
          <td class="t-right">{{ '%.2f' % it.line_total }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Totals -->
    <div class="totals">
      <table>
        <tr>
          <td class="t-right muted">Subtotal</td>
          <td class="t-right">{{ '%.2f' % totals.subtotal_before_order_discount }}</td>
        </tr>
        {% if totals.line_discount_total %}
        <tr>
          <td class="t-right muted">Line Discount Total</td>
          <td class="t-right">{{ '%.2f' % totals.line_discount_total }}</td>
        </tr>
        {% endif %}
        {% if totals.order_discount %}
        <tr>
          <td class="t-right muted">Order Discount</td>
          <td class="t-right">{{ '%.2f' % totals.order_discount }}</td>
        </tr>
        {% endif %}
        <tr class="rule">
          <td class="t-right"><strong>Total</strong></td>
          <td class="t-right"><strong>{{ '%.2f' % totals.total }}</strong></td>
        </tr>
      </table>
    </div>

    <!-- Payments / Balance (sales only) -->
    <div class="totals" style="margin-top:8px;">
      <table>
        <tr>
          <td class="t-right muted">Paid to Date</td>
          <td class="t-right">{{ '%.2f' % paid_amount }}</td>
        </tr>
        <tr class="rule">
          <td class="t-right"><strong>Remaining</strong></td>
          <td class="t-right">
            <strong>{{ '%.2f' % remaining }}</strong>
          </td>
        </tr>
        {% if credit_applied is defined %}
        <tr>
          <td class="t-right muted">Returns/Credits Applied</td>
          <td class="t-right">{{ '%.2f' % credit_applied }}</td>
        </tr>
        {% endif %}
      </table>
    </div>

    <!-- Initial Payment Details -->
    {% if initial_payment %}
    <div class="payment-details">
      <div class="payment-card">
        <h3>Initial Payment Details</h3>
        <div class="payment-grid">
          <div><strong>Method:</strong> {{ initial_payment.method|default('N/A')|e }}</div>
          <div><strong>Date:</strong> {{ (initial_payment.date or doc.date)|e }}</div>
          {% if initial_payment.bank_account_id %}
          <div><strong>Company Account:</strong> {{ initial_payment.bank_account_label|default('N/A')|e }}</div>
          {% endif %}
          {% if initial_payment.instrument_no %}
          <div><strong>Instrument No:</strong> {{ initial_payment.instrument_no|default('N/A')|e }}</div>
          {% endif %}
          {% if initial_payment.instrument_date %}
          <div><strong>Instrument Date:</strong> {{ initial_payment.instrument_date|default('')|e }}</div>
          {% endif %}
          {% if initial_payment.ref_no %}
          <div><strong>Reference No:</strong> {{ initial_payment.ref_no|default('')|e }}</div>
          {% endif %}
          {% set notes = initial_payment.notes|default('')|trim %}
          {% if notes and notes != 'Init payment' and notes != '[Init payment]' %}
          <div><strong>Notes:</strong> {{ notes|e }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Footer -->
    <div class="footer">
      <div>Thank you for your business!</div>
      <!-- Optional slim contact strip could go here -->
    </div>
  </div>
</body>
</html>
